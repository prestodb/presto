name: prestocpp-linux-build-and-unit-test

# ==============================================================================
# Prestocpp (C++ Native Worker) Build, Tests, and Image
# ==============================================================================
# This workflow builds the C++ native worker (prestocpp), runs unit tests, and
# builds the prestissimo runtime Docker image.
#
# What is Prestocpp/Prestissimo?
# ------------------------------
# - Prestocpp: The C++ source code for the native Presto worker
# - Prestissimo: The runtime/deployment name for the compiled C++ worker
#
# Job Dependency Graph:
# ---------------------
#   prestocpp-linux-build-and-test ─► prestissimo-image
#
# Build Strategy:
# ---------------
# Uses a pre-built Docker image ("builder image") with:
# - All C++ dependencies pre-installed (boost, folly, glog, etc.)
# - Pre-warmed ccache containing compiled object files from a previous build

on:
  workflow_call:
    inputs:
      builder-image:
        description: 'Full builder image URI with tag'
        required: true
        type: string
      image-version-type:
        description: 'Docker image version type (RELEASE, BETA, DEV)'
        required: false
        default: 'RELEASE'
        type: string

# Note: concurrency is handled by the parent ci.yml workflow

jobs:
  # ----------------------------------------------------------------------------
  # Job 1: Build and Test Prestocpp
  # ----------------------------------------------------------------------------
  # Builds the prestocpp binary, runs unit tests, and uploads artifacts.
  prestocpp-linux-build-and-test:
    name: "prestocpp-linux-build-and-test"
    runs-on: self-hosted
    timeout-minutes: 180
    container:
      image: ${{ inputs.builder-image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      CCACHE_DIR: /var/cache/ccache
      CCACHE_BASEDIR: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
        with:
          show-progress: false

      - name: Fix git permissions
        run: git config --global --add safe.directory ${GITHUB_WORKSPACE}

      - name: Update velox submodule
        run: |
          cd presto-native-execution
          make velox-submodule

      - name: Build engine
        run: |
          cd presto-native-execution
          cmake \
            -B _build/release \
            -GNinja \
            -DTREAT_WARNINGS_AS_ERRORS=1 \
            -DENABLE_ALL_WARNINGS=1 \
            -DCMAKE_BUILD_TYPE=Release \
            -DPRESTO_ENABLE_PARQUET=ON \
            -DPRESTO_ENABLE_REMOTE_FUNCTIONS=ON \
            -DPRESTO_ENABLE_JWT=ON \
            -DPRESTO_STATS_REPORTER_TYPE=PROMETHEUS \
            -DPRESTO_MEMORY_CHECKER_TYPE=LINUX_MEMORY_CHECKER \
            -DCMAKE_PREFIX_PATH=/usr/local \
            -DThrift_ROOT=/usr/local \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DMAX_LINK_JOBS=4
          ninja -C _build/release -j $(getconf _NPROCESSORS_ONLN)

      - name: Show ccache statistics
        run: ccache -s

      - name: Run unit tests
        run: |
          ldconfig /usr/local/lib
          cd presto-native-execution/_build/release
          ctest -j $(getconf _NPROCESSORS_ONLN) -VV --output-on-failure --exclude-regex velox.*

      # Upload compiled binaries as artifacts for integration tests and image building
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: presto-native-build
          retention-days: 1
          path: |
            presto-native-execution/_build/release/presto_cpp/main/presto_server
            presto-native-execution/_build/release/velox/velox/functions/remote/server/velox_functions_remote_server_main

  # ----------------------------------------------------------------------------
  # Job 2: Build Prestissimo Runtime Image
  # ----------------------------------------------------------------------------
  # Downloads the pre-built binary and packages it into a minimal Docker image.
  # The runtime image contains only the binary and runtime dependencies (no build tools).
  prestissimo-image:
    name: "prestissimo-image"
    needs: prestocpp-linux-build-and-test
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          show-progress: false

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: presto-native-build
          path: presto-native-execution/_build/release

      - name: Restore execute permissions
        run: |
          chmod +x presto-native-execution/_build/release/presto_cpp/main/presto_server
          chmod +x presto-native-execution/_build/release/velox/velox/functions/remote/server/velox_functions_remote_server_main || true
          ls -lh presto-native-execution/_build/release/presto_cpp/main/presto_server

      - name: Extract version info
        id: extract-version
        run: |
          # Extract version from pom.xml
          VERSION=$(grep '<version>' pom.xml | head -1 | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          echo "Version from pom.xml: $VERSION"

          # Get short commit hash
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "Short commit hash: $SHORT_SHA"

          # Get commit timestamp in UTC (format: YYYYMMDDHHMMSS for lexicographic sorting)
          TIMESTAMP=$(git show -s --format=%cd --date=format:'%Y%m%d%H%M%S' HEAD)
          echo "Commit timestamp: $TIMESTAMP"

          # Output version info
          echo "base-version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}-${{ inputs.image-version-type }}-${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push prestissimo runtime image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./presto-native-execution/scripts/dockerfiles/prestissimo-runtime.dockerfile
          build-args: |
            BUILDER_IMAGE=${{ inputs.builder-image }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ghcr.io/${{ github.repository }}/prestissimo:${{ steps.extract-version.outputs.version }}
            ghcr.io/${{ github.repository }}/prestissimo:${{ steps.extract-version.outputs.base-version }}-${{ inputs.image-version-type }}-SNAPSHOT
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
