name: prestocpp-linux-container-tests

permissions:
  contents: read

on:
  workflow_dispatch: {}
  pull_request:
    paths:
      - presto-native-execution/**
      - presto-native-sidecar-plugin/**
      - .github/workflows/prestocpp-linux-container-tests.yml

env:
  CONTINUOUS_INTEGRATION: true
  DOCKER_BUILDKIT: 1
  MAVEN_OPTS: -Xmx2G -XX:+ExitOnOutOfMemoryError
  MAVEN_FAST_INSTALL: -B -V -T 1C -DskipTests -Dair.check.skip-all --no-transfer-progress -Dmaven.javadoc.skip=true
  MAVEN_TEST: -B -Dair.check.skip-all -Dmaven.javadoc.skip=true --no-transfer-progress --fail-at-end

# -----------------------------
# Job 1: Build worker image
# -----------------------------
jobs:

  build-worker-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Free base disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          docker system prune -af
          df -h

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Update velox
        run: |
          cd presto-native-execution
          make velox-submodule

      - name: Build dependency image
        run: |
          cd presto-native-execution
          docker build \
            -t presto-native-dependency:latest \
            -f scripts/dockerfiles/centos-dependency.dockerfile \
            --progress=plain \
            .

      - name: Build worker image (BuildKit)
        run: |
          cd presto-native-execution
          export DOCKER_BUILDKIT=1
          docker build \
            -t presto-worker:latest \
            --build-arg BUILD_TYPE=Release \
            --build-arg DEPENDENCY_IMAGE=presto-native-dependency:latest \
            --build-arg EXTRA_CMAKE_FLAGS="-DPRESTO_ENABLE_TESTING=OFF -DPRESTO_ENABLE_PARQUET=ON -DPRESTO_ENABLE_S3=ON" \
            --build-arg NUM_THREADS=2 \
            -f scripts/dockerfiles/prestissimo-runtime.dockerfile \
            --progress=plain \
            .

      - name: Save Docker image
        run: |
          docker save presto-worker:latest -o presto-worker.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: presto-worker
          retention-days: 1
          path: presto-worker.tar

      - name: Verify Buildx builder
        run: |
          echo "BUILDX_BUILDER=$BUILDX_BUILDER"
          docker buildx inspect "$BUILDX_BUILDER"

  # -----------------------------
  # Job 2: Build coordinator image
  # -----------------------------
  build-coordinator-image:
    runs-on: ubuntu-latest
    needs: build-worker-image
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Free base disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          docker system prune -af
          df -h

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Build Java artifacts only
        run: |
          ./mvnw clean install ${MAVEN_FAST_INSTALL} \
            -Denable.docker.build.worker=false \
            -Denable.docker.build.coordinator=false \
            -pl '!:presto-product-tests,!:presto-router,!:presto-docs,!:presto-verifier,!:presto-test-coverage'

      - name: Build coordinator image (BuildKit)
        run: |
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)

          cd docker

          cp ../presto-server/target/presto-server-${VERSION}.tar.gz .
          cp ../presto-cli/target/presto-cli-${VERSION}-executable.jar .

          export DOCKER_BUILDKIT=1

          docker build \
            -t presto-coordinator:latest \
            --build-arg PRESTO_VERSION=${VERSION} \
            --progress=plain \
            .

      - name: Save Docker image
        run: |
          docker save presto-coordinator:latest -o presto-coordinator.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: presto-coordinator
          retention-days: 1
          path: presto-coordinator.tar

  # -----------------------------
  # Job 3: Run container tests
  # -----------------------------
  run-container-tests:
    runs-on: ubuntu-latest
    needs: build-coordinator-image
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Free base disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          docker system prune -af --volumes
          df -h

      - name: Download worker image
        uses: actions/download-artifact@v4
        with:
          name: presto-worker

      - name: Download coordinator image
        uses: actions/download-artifact@v4
        with:
          name: presto-coordinator

      - name: Load Docker images
        run: |
          docker load -i "presto-coordinator:latest/presto-coordinator.tar"
          docker load -i "presto-worker:latest/presto-worker.tar"

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Run presto-native container tests
        run: |
          export PRESTO_SERVER_PATH="${GITHUB_WORKSPACE}/presto-native-execution/_build/release/presto_cpp/main/presto_server"
          export TESTFILES=$(find ./presto-native-execution/src/test -type f -name 'TestPrestoContainer*.java')
          TESTCLASSES=$(echo "$TESTFILES" | sed 's|.*/||; s|\.java||' | paste -sd, -)
          echo "TESTCLASSES=$TESTCLASSES"

          mvn test \
            ${MAVEN_TEST} \
            -pl presto-native-execution \
            -Dtest="$TESTCLASSES" \
            -DPRESTO_SERVER="$PRESTO_SERVER_PATH" \
            -DDATA_DIR="$RUNNER_TEMP" \
            -Duser.timezone=America/Bahia_Banderas
