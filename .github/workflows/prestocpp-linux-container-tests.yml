name: prestocpp-linux-container-tests

permissions:
  contents: read

on:
  workflow_dispatch: {}
  pull_request:
    paths:
      - presto-native-execution/**
      - presto-native-sidecar-plugin/**
      - .github/workflows/prestocpp-linux-container-tests.yml

env:
  CONTINUOUS_INTEGRATION: true
  DOCKER_BUILDKIT: 1
  MAVEN_OPTS: -Xmx2G -XX:+ExitOnOutOfMemoryError
  MAVEN_FAST_INSTALL: -B -V -T 1C -DskipTests -Dair.check.skip-all --no-transfer-progress -Dmaven.javadoc.skip=true
  MAVEN_TEST: -B -Dair.check.skip-all -Dmaven.javadoc.skip=true --no-transfer-progress --fail-at-end

# -----------------------------
# Job 1: Build worker image
# -----------------------------
jobs:
  build-worker-image:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Free base disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          docker system prune -af
          df -h

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Update velox
        run: |
          cd presto-native-execution
          make velox-submodule

      - name: Enable Docker BuildKit (daemon)
        run: |
          sudo mkdir -p /etc/docker
          echo '{ "features": { "buildkit": true } }' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          docker info | grep -i buildkit || true

      - name: Build worker image
        run: |
          ./mvnw install ${MAVEN_FAST_INSTALL} \
            -Pdocker-build \
            -Denable.docker.build.worker=true \
            -pl '!:presto-product-tests,!:presto-router,!:presto-docs,!:presto-verifier,!:presto-test-coverage'

      - name: Prune docker build cache
        run: |
          docker builder prune --all --force
          docker system prune -af
          df -h

  # -----------------------------
  # Job 2: Build coordinator image
  # -----------------------------
  build-coordinator-image:
    runs-on: ubuntu-22.04
    needs: build-worker-image
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Free base disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          docker system prune -af
          df -h

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Update velox
        run: |
          cd presto-native-execution
          make velox-submodule

      - name: Enable Docker BuildKit (daemon)
        run: |
          sudo mkdir -p /etc/docker
          echo '{ "features": { "buildkit": true } }' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          docker info | grep -i buildkit || true

      - name: Build coordinator image
        run: |
          ./mvnw install ${MAVEN_FAST_INSTALL} \
            -Pdocker-build \
            -Denable.docker.build.coordinator=true \
            -pl '!:presto-product-tests,!:presto-router,!:presto-docs,!:presto-verifier,!:presto-test-coverage'

      - name: Prune docker build cache
        run: |
          docker builder prune --all --force
          docker system prune -af
          df -h

  # -----------------------------
  # Job 3: Run container tests
  # -----------------------------
  run-container-tests:
    runs-on: ubuntu-22.04
    needs: build-coordinator-image
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Free base disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          docker system prune -af --volumes
          df -h

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Run presto-native container tests
        run: |
          export PRESTO_SERVER_PATH="${GITHUB_WORKSPACE}/presto-native-execution/_build/release/presto_cpp/main/presto_server"
          export TESTFILES=$(find ./presto-native-execution/src/test -type f -name 'TestPrestoContainer*.java')
          TESTCLASSES=$(echo "$TESTFILES" | sed 's|.*/||; s|\.java||' | paste -sd, -)
          echo "TESTCLASSES=$TESTCLASSES"

          mvn test \
            ${MAVEN_TEST} \
            -pl presto-native-execution \
            -Dtest="$TESTCLASSES" \
            -DPRESTO_SERVER="$PRESTO_SERVER_PATH" \
            -DDATA_DIR="$RUNNER_TEMP" \
            -Duser.timezone=America/Bahia_Banderas

      - name: Final docker cleanup
        if: always()
        run: |
          docker system prune -af --volumes
          docker builder prune --all --force
          df -h
