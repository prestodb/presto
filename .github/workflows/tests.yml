name: tests

# ==============================================================================
# Presto Java Unit Tests
# ==============================================================================
# Runs unit tests for the Java components of Presto using a matrix strategy.
#
# Matrix Strategy Explained:
# --------------------------
# GitHub Actions "matrix" runs the same job multiple times with different parameters.
# This workflow creates a matrix of:
#   - java: ['8.0.442', '17.0.13'] (2 versions)
#   - modules: 11 different test modules/profiles
#
# This results in 2 Ã— 11 = 22 parallel test jobs! Each combination runs independently.
#
# Test Modules:
# -------------
# Tests are split by Maven profile (-P flag) to parallelize and categorize:
# - presto-tests-execution-memory: Memory management tests
# - presto-tests-general: General functionality tests
# - ci-only-*: Test profiles that only run in CI (too slow/resource-intensive for local)
# - presto-main-base, presto-main: Core module tests
#
# fail-fast: false means if one matrix job fails, others continue running.
# This helps identify all failing tests rather than stopping at the first failure.

on:
  workflow_call:
    inputs:
      builder-image:
        description: 'Full builder image URI with tag'
        required: true
        type: string

jobs:
  test:
    name: "presto-tests"
    runs-on: self-hosted
    strategy:
      fail-fast: false  # Continue other jobs even if one fails
      matrix:
        java: ['8.0.442', '17.0.13']
        modules:
          - ":presto-tests -P presto-tests-execution-memory"
          - ":presto-tests -P presto-tests-general"
          - ":presto-tests -P ci-only-distributed-non-hash-gen"
          - ":presto-tests -P ci-only-tpch-distributed-queries"
          - ":presto-tests -P ci-only-local-queries"
          - ":presto-tests -P ci-only-distributed-queries"
          - ":presto-tests -P ci-only-aggregation-queries"
          - ":presto-tests -P ci-only-plan-determinism"
          - ":presto-tests -P ci-only-resource-manager"
          - ":presto-main-base"
          - ":presto-main"
    timeout-minutes: 80
    container:
      image: ${{ inputs.builder-image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      # Maven test flags:
      # - -Dair.check.skip-all: Skip static analysis checks (already done in build)
      # - -DLogTestDurationListener.enabled=true: Log how long each test takes
      # - --fail-at-end: Run all tests even if some fail, report failures at end
      MAVEN_TEST: "-B -Dair.check.skip-all -Dmaven.javadoc.skip=true -DLogTestDurationListener.enabled=true --no-transfer-progress --fail-at-end"
      MAVEN_REPO: /opt/maven/repository
      MAVEN_INSTALL_OPTS: "-Xmx2G -XX:+ExitOnOutOfMemoryError"
    steps:
      - uses: actions/checkout@v4
        with:
          show-progress: false

      # Setup Java version from the matrix (runs twice: once for Java 8, once for Java 17)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java }}

      # setup-java may override MAVEN_REPO, so explicitly set it after
      - name: Configure Maven repository
        run: |
          echo "MAVEN_REPO=/opt/maven/repository" >> $GITHUB_ENV

      # First, compile the test module and its dependencies (-am = also make dependencies)
      # The cut command extracts just the module name (before any -P profile flags)
      # Example: ":presto-tests -P presto-tests-general" -> ":presto-tests"
      - name: Maven Install
        run: |
          export MAVEN_OPTS="${MAVEN_INSTALL_OPTS}"
          ./mvnw install -B -V --quiet -T 1C -DskipTests -Dair.check.skip-all --no-transfer-progress -Dmaven.javadoc.skip=true -Dmaven.repo.local=${{ env.MAVEN_REPO }} -am -pl $(echo '${{ matrix.modules }}' | cut -d' ' -f1)

      # Run the actual tests for this matrix combination
      # -pl specifies both the module and the profile (e.g., ":presto-tests -P ci-only-local-queries")
      - name: Maven Tests
        run: |
          ./mvnw test ${MAVEN_TEST} -Dmaven.repo.local=${{ env.MAVEN_REPO }} -pl ${{ matrix.modules }}
